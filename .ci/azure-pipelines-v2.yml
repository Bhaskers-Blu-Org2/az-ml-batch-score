# MLAKSDeploy Pipeline
resources:
  repositories:
    - repository: aitemplates
      type: github
      name: microsoft/AI
      endpoint: AIArchitecturesAndPractices-GitHub

variables:
  BuildConfiguration: Release
  BuildBinariesDirectory: $(Build.BinariesDirectory)
  BuildPlatform: any cpu
  DotNetCoreBuildVersion: 2.2.108
  DotNetRuntimeTarget: ubuntu.18.04-x64
  AgentToolsDirectory: $(Agent.ToolsDirectory)
  CloudPlatform: AzureCloud
  ProductName: Trident
  TridentWorkloadType: $(WorkloadType)
  TridentWorkloadTypeShort: $(WorkloadTypeShort)
  DeployLocations: eastus
  Agent: agce-ai
  azureSubscription: AG-AzureCAT-AIDevOps-Test-COGSNonProd-IO1685734(0ca618d2-22a8-413a-96d0-0f1b531129c3)
  azure_subscription: 0ca618d2-22a8-413a-96d0-0f1b531129c3

trigger:
  batch: true
  branches:
    include:
    - master

jobs:
- job: build_relayer_sources
  displayName: 'Build Trident Server Sources'

  pool:
    name: $(AgentPoolName)

  workspace:
    clean: all

  steps:
    - template: TridentServer/yaml-templates/azure-pipeline-build-template.yml
      parameters:
        ProjectBasePath: $(RelayerBasePath)
        BuildConfiguration: $(BuildConfiguration)
        BuildBinariesDirectory: $(BuildBinariesDirectory)
        BuildPlatform: $(BuildPlatform)
        DotNetCoreBuildVersion: $(DotNetCoreBuildVersion)
        DotNetRuntimeTarget: $(DotNetRuntimeTarget)
        WorkerRolePrefix: relayer-
        AgentToolsDirectory: $(AgentToolsDirectory)

    # Get the artifacts saved during build to be used for this deployment steps
    - task: DownloadBuildArtifacts@0
      displayName: 'Download ConfigService Artifacts'
      inputs:
        artifactName: configService
        downloadPath: $(System.DefaultWorkingDirectory)

    # Generate a deployment guid that uniquely identifies this deployment
    - task: PowerShell@2
      displayName: 'PowerShell Script - Generate deployment GUID'
      name: 'GenDeployGuidTag'
      inputs:
        targetType: filePath
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        filePath: './configService/DeploymentScripts/GenerateDeploymentGuid.ps1'

    # Generate Start Deployment Time Stamp
    - task: PowerShell@2
      displayName: 'PowerShell Script - Generate deployment time stamp'
      name: 'GenDeployTimeStamp'
      inputs:
        targetType: filePath
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        filePath: './configService/DeploymentScripts/GenerateDeploymentTimestamp.ps1'

 
    # To generate the proper format to deployto multiple regions from yaml the
    # comma separated list of regions needs to be converted to specific json
    # format. Details here:
    # https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases?view=azure-devops&tabs=yaml#multi-configuration
    - task: PowerShell@2
      displayName: 'PowerShell Script - Generate deployment location matrix'
      name: 'GenDeployMatrix'
      inputs:
        targetType: filePath
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        filePath: './configService/DeploymentScripts/GenerateRegionalDeploymentMatrix.ps1'
        arguments: '-DeployLocations ''$(DeployLocations)'''

- job: build_deploy_ai
  displayName: 'Build deploy AI'

  strategy:
    maxParallel: 8
    matrix: $[ dependencies.build_relayer_sources.outputs['GenDeployMatrix.DeployRegions'] ]
  timeoutInMinutes: 180

  workspace:
    clean: all

  variables:
    DeploymentGuidTag: $[ dependencies.build_relayer_sources.outputs['GenDeployGuidTag.DeploymentGuid'] ]
    DeploymentTimeStamp: $[ dependencies.build_relayer_sources.outputs['GenDeployTimeStamp.timeStamp'] ]
    EnvironmentPrefix: $(TridentWorkloadType)-$(CloudPlatform)-$(DeployLocation)$(TestPostfix)
    ResourcePrefix: $(TridentWorkloadTypeShort)-$(DeployLocation)$(TestPostfix)
    EnvironmentContext: $(EnvironmentPrefix)-$(DeploymentGuidTag)
    AIResourceGroupName: $(TridentWorkloadTypeShort)-$(DeployLocation)$(TestPostfix)

  steps:

  #
  # DL Workload Deployment
  #
    # use the ML team templates to build and deploy workloads for each region
  - script: |
      docker stop $(docker ps -a -q)
      docker rm $(docker ps -a -q)
      docker system prune -a -f
      rm -rf AI
      git clone --recurse-submodules https://github.com/microsoft/AI.git
    displayName: 'git clone sources'

  - bash: |
      Deploy_Location_Short=$(echo $DeployLocation | cut -c1-12)
      echo "##vso[task.setvariable variable=Deploy_Location_Short]$Deploy_Location_Short"


  - template: .ci/steps/deploy_steps.yml@aitemplates
    parameters:
      deployment_name: MLBatchDeployAMLJob
      template: MLBatchDeployAMLJob.yml
      azureSubscription: $(azureSubscription)
      azure_subscription: $(azure_subscription)
      azureresourcegroup: $(AIResourceGroupName)
      workspacename: $(TridentWorkloadTypeShort)-$(DeployLocation)
      azureregion: $(DeployLocation)
      aksimagename: myimage
      environment: $(EnvironmentContext)
      doCleanup: False
      alias: $(Build.QueuedBy)
      project: $(TridentWorkloadTypeShort)
      agent: "Hosted Ubuntu 1604"
      ENVIRONMENT_PREFIX: $(EnvironmentPrefix)
      deploymentguidtag: $(DeploymentGuidTag)
      aks_name: $(TridentWorkloadTypeShort)$(Deploy_Location_Short)
      python_path: "$(System.DefaultWorkingDirectory)/AI/submodules/DeployMLModelPipelines"
      location: AI/submodules/DeployMLModelPipelines
      python_secret_root: "./AI/"
